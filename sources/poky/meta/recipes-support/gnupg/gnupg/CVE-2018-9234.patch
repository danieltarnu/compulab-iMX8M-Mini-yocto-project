From ce055269c80f6e7c1393c0deec7bc5f0d37895ea Mon Sep 17 00:00:00 2001
From: Sinan Kaya <okaya@kernel.org>
Date: Sun, 23 Sep 2018 04:05:47 +0000
Subject: [PATCH] g10: Fix filtering by PK->REQ_USAGE

Upstream-Status: Backport [https://dev.gnupg.org/rGa17d2d1f690ebe5d005b4589a5fe378b6487c657]
CVE: CVE-2018-9234
Signed-off-by: Sinan Kaya <okaya@kernel.org>
---
 g10/getkey.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/g10/getkey.c b/g10/getkey.c
index e31e023..ca2500c 100644
--- a/g10/getkey.c
+++ b/g10/getkey.c
@@ -1810,6 +1810,8 @@ get_pubkey_byfprint (ctrl_t ctrl, PKT_public_key *pk, kbnode_t *r_keyblock,
       ctx.items[0].mode = fprint_len == 16 ? KEYDB_SEARCH_MODE_FPR16
 	: KEYDB_SEARCH_MODE_FPR20;
       memcpy (ctx.items[0].u.fpr, fprint, fprint_len);
+      if (pk)
+        ctx.req_usage = pk->req_usage;
       rc = lookup (ctrl, &ctx, 0, &kb, &found_key);
       if (!rc && pk)
 	pk_from_block (pk, kb, found_key);
-- 
2.19.0

